app-id: net.jami.Jami
base: io.qt.qtwebengine.BaseApp
base-version: '6.10'
runtime: org.kde.Platform
runtime-version: '6.10'
sdk: org.kde.Sdk
command: jami

finish-args:
  # Share IPC namespace with host
  - --share=ipc
  # Display windows with Wayland (fallback to X11 otherwise)
  - --socket=wayland
  - --socket=fallback-x11
  # Audio access (includes ALSA)
  - --socket=pulseaudio
  # Network access
  - --share=network
  # Provides access to all devices
  - --device=all
  - --allow=per-app-dev-shm
  # Inhibit sleep
  - --system-talk-name=org.freedesktop.login1
  - --talk-name=org.gnome.SessionManager
  - --talk-name=org.freedesktop.PowerManagement
  - --talk-name=org.freedesktop.ScreenSaver
  # Notifs & tray icons
  - --talk-name=org.gnome.Mutter.IdleMonitor
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=com.canonical.AppMenu.Registrar
  - --talk-name=com.canonical.indicator.application
  - --talk-name=org.ayatana.indicator.application
  - --talk-name=com.canonical.Unity
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.ScreenSaver
  # Qt environment variables 
  - --env=QML_IMPORT_PATH=/app/qml
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess

cleanup:
  - "*.a"
  - "*.la"
  - /lib/pkgconfig
  - /lib/cmake
  - /lib/mkspecs
  - /lib/x86_64-linux-gnu/
  - /include
  - /share/pixmaps
  - /share/man
  - /share/doc
  - /share/cmake
  - /share/pkgconfig
  - /bin/notify-send
  - /bin/sdbus-c++-xml2cpp
  - /bin/tv_ctrlpt
  - /man
  - /share/QWindowKit

cleanup-commands:
  - /app/cleanup-BaseApp.sh

modules:
  - name: jami-client-qt
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DFETCHCONTENT_TRY_FIND_PACKAGE_MODE=ALWAYS
      - -DCMAKE_BUILD_TYPE=Release
      - -DWITH_WEBENGINE=ON
      - -DENABLE_LIBWRAP=ON
      - -DBUILD_TESTING=OFF
      - -DBUILD_SHARED_LIBS=OFF
      - -DBUILD_CONTRIB=OFF
      - -DCMAKE_INSTALL_LIBDIR=lib
      - -DCMAKE_EXE_LINKER_FLAGS=-Wl,-Bsymbolic
      - -DCMAKE_MODULE_LINKER_FLAGS=-Wl,-Bsymbolic
      - -DCMAKE_SHARED_LINKER_FLAGS=-Wl,-Bsymbolic

    sources:
      - type: git
        url: https://git.jami.net/savoirfairelinux/jami-client-qt
        commit: 5ba557913a732708b959355bdae4f7da3c88913c
      - type: patch
        path: patches/jami-client-qt-patches/jami-daemon_replace-static.patch
      - type: patch
        path: patches/jami-client-qt-patches/jami-daemon_video.patch
    modules:
      # FFMPEG deps
      - dependencies/x264.yml
      - dependencies/ffnvcodec.yml
      - dependencies/ffmpeg.yml
      # opendht deps
      - dependencies/argon2.yml
      - dependencies/asio.yml
      - dependencies/llhttp.yml
      - dependencies/expected-lite.yml
      - dependencies/restinio.yml
      - dependencies/msgpack-cxx.yml
      - dependencies/jsoncpp.yml
      - dependencies/simdutf.yml
      - dependencies/opendht.yml
      # dhtnet deps
      - dependencies/pjproject.yml
      - dependencies/libnatpmp.yml
      - dependencies/libupnp.yml
      - dependencies/dhtnet.yml
      # jami-daemon deps
      - dependencies/libgit2.yml
      - dependencies/yaml-cpp.yml
      - dependencies/libsecp256k1.yml
      - dependencies/webrtc-audio-processing.yml
      - dependencies/sdbus-c++.yml
      # jami-client-qt deps
      - dependencies/tidy-html5.yml
      - dependencies/qrencode.yml
      - dependencies/qwindowkit.yml
